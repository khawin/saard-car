<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ระบบขออนุญาตใช้ยานพาหนะ - โรงเรียนสอาดเผดิมวิทยา</title>
    <link rel="icon" href="https://www.saard.ac.th/wp-content/uploads/2024/11/saardlogov2-1-1024x1024.png" type="image/png">
    
    <!-- Fonts: Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                    },
                    colors: {
                        primary: { DEFAULT: '#3B82F6', dark: '#1E40AF' }, // ฟ้า
                        secondary: { DEFAULT: '#EC4899', dark: '#BE185D' }, // ชมพู
                        schoolGray: '#F3F4F6' // เทาอ่อน
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.15)',
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'blob': 'blob 7s infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- SweetAlert2 -->
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-material-ui/material-ui.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 50%, #fce7f3 100%);
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .hidden-section { display: none !important; }
        
        /* Custom Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);
            border: none;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(59, 130, 246, 0.35); }
        .btn-primary:active { transform: translateY(0); }
        
        .btn-secondary {
            background: white;
            color: #4B5563;
            border: 1px solid #E5E7EB;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover { background: #F9FAFB; border-color: #3B82F6; color: #3B82F6; }

        /* Mobile Optimization */
        @media (max-width: 640px) {
            .btn-primary, .btn-secondary {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
            }
            .nav-toggle-text {
                display: none;
            }
            .nav-toggle-btn {
                padding: 0.5rem 0.5rem !important; /* Adjusted padding */
            }
        }

        /* Custom Input */
        .custom-input {
            width: 100%;
            padding: 0.85rem 1rem;
            border: 2px solid #E5E7EB;
            border-radius: 0.75rem;
            background: #ffffff;
            transition: all 0.2s;
            outline: none;
            font-size: 1rem;
        }
        .custom-input:focus {
            border-color: #3B82F6;
            background: white;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        /* SweetAlert Customization */
        .swal2-popup {
            border-radius: 24px !important;
            padding: 1.5rem !important;
            font-family: 'Sarabun', sans-serif !important;
        }
        .swal2-confirm { background: linear-gradient(to right, #3B82F6, #2563EB) !important; }
        .swal2-deny { background: #EF4444 !important; }

        /* Table Styling */
        .glass-table thead th {
            background-color: rgba(59, 130, 246, 0.1);
            color: #1E40AF;
            font-weight: 600;
            padding: 1rem;
        }
        .glass-table tbody td {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            vertical-align: middle;
        }
        
        /* Mobile Card View for Tables */
        .mobile-card {
            background: white;
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid #f3f4f6;
        }
        .mobile-card-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .mobile-card-label {
            color: #6B7280;
            font-weight: 500;
        }
        .mobile-card-value {
            color: #1F2937;
            font-weight: 600;
            text-align: right;
            max-width: 65%;
            word-break: break-word;
        }

        /* Timeline View */
        .timeline-bar {
            height: 1.5rem;
            background-color: #E5E7EB;
            border-radius: 9999px;
            position: relative;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .timeline-segment {
            position: absolute;
            height: 100%;
            top: 0;
            transition: all 0.3s ease;
        }
        .segment-approved { background-color: #EF4444; opacity: 0.9; } /* Red for busy */
        .segment-pending { background-color: #FBBF24; opacity: 0.9; } /* Yellow for pending */
        
        .time-scale {
            display: flex;
            justify-content: space-between;
            font-size: 0.6rem;
            color: #9CA3AF;
            margin-top: 2px;
            padding: 0 2px;
        }

        /* Active Card State in Manage (Admin) */
        .manage-card-active {
            border-color: #EC4899 !important; /* Pink 500 */
            background-color: #FDF2F8 !important; /* Pink 50 */
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .manage-card-inactive {
            border-color: transparent !important;
            opacity: 0.7;
        }
        .manage-card-inactive:hover {
            opacity: 1;
            border-color: #FBCFE8 !important; /* Pink 200 */
        }

        /* Active Card State in Dashboard (Home) */
        .dash-active {
            opacity: 1 !important;
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
        }
        .dash-inactive {
            opacity: 0.6 !important;
            transform: scale(0.98);
        }
        .dash-inactive:hover {
            opacity: 0.9 !important;
            transform: scale(1);
        }

        /* PDF Templates */
        #pdf-container { position: absolute; top: -9999px; left: -9999px; }
        .pdf-page { background: white; color: black; font-family: 'Sarabun', sans-serif; padding: 20mm; box-sizing: border-box; }
        .pdf-header { text-align: center; font-weight: bold; font-size: 18px; margin-bottom: 10px; }
        .pdf-content { font-size: 14px; line-height: 1.5; }
        .pdf-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .dotted-line { border-bottom: 1px dotted #000; display: inline-block; min-width: 20px; text-align: center; color: #000; padding: 0 5px; }
        .checkbox-box { display: inline-block; width: 14px; height: 14px; border: 1px solid #000; margin-right: 6px; vertical-align: middle; position: relative; margin-bottom: 3px; }
        .checkbox-checked::after { content: '✓'; position: absolute; top: -5px; left: 1px; font-size: 16px; font-weight: bold; color: black; }
        
        /* แก้ไข PDF รายงานสรุป (Landscape) */
        #pdf-summary-template { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start;
            padding: 15mm 10mm; 
            width: 297mm; 
        }
        .summary-table-container {
            width: 100%;
            display: flex;
            justify-content: center;
        }
        .summary-table { 
            width: 98%; 
            border-collapse: collapse; 
            font-size: 14px; 
            margin: 0 auto;
            table-layout: fixed; 
        }
        .summary-table th, .summary-table td { 
            border: 1px solid black; 
            padding: 8px 4px; 
            text-align: center; 
            vertical-align: middle;
            word-wrap: break-word;
            line-height: 1.3;
            letter-spacing: 0.5px; 
        }
        .summary-table th { 
            background-color: #f0f0f0; 
            font-weight: 600; 
            height: 45px;
            font-size: 14px;
            letter-spacing: 0.5px; 
        }
        .text-left-align { text-align: left !important; padding-left: 8px !important; }

        .animation-delay-2000 { animation-delay: 2s; }
        .animation-delay-4000 { animation-delay: 4s; }
    </style>
</head>
<body class="text-gray-700 antialiased selection:bg-pink-200 selection:text-pink-900">

    <!-- ================= 1. Login Section ================= -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4 relative overflow-hidden">
        <div class="absolute top-0 -left-4 w-72 h-72 bg-blue-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
        <div class="absolute top-0 -right-4 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
        <div class="absolute -bottom-8 left-20 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>

        <div class="glass-effect rounded-[2rem] shadow-2xl w-full max-w-md overflow-hidden relative z-10 animate-fade-in border-white/60">
            <div class="p-8 md:p-10">
                <div class="text-center mb-8">
                    <img src="https://www.saard.ac.th/wp-content/uploads/2024/11/saardlogov2-1-1024x1024.png" alt="Logo" class="w-24 h-24 mx-auto mb-4 object-contain drop-shadow-md hover:scale-105 transition-transform">
                    <h2 class="text-2xl font-bold text-gray-800 tracking-wide">ระบบขออนุญาตใช้ยานพาหนะ</h2>
                    <p class="text-gray-500 mt-1 font-medium">โรงเรียนสอาดเผดิมวิทยา</p>
                </div>

                <div class="flex bg-gray-100 p-1.5 rounded-2xl mb-8 relative">
                    <div id="role-indicator" class="absolute h-[calc(100%-0.75rem)] w-[calc(50%-0.375rem)] bg-white rounded-xl shadow-sm transition-all duration-300 ease-out top-1.5 left-1.5 pointer-events-none"></div>
                    <button onclick="switchRole('teacher')" id="btn-login-teacher" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all relative z-10 text-blue-600">บุคลากรครู</button>
                    <button onclick="switchRole('admin')" id="btn-login-admin" class="flex-1 py-2.5 rounded-xl text-sm font-bold transition-all relative z-10 text-gray-400">หัวหน้างาน</button>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700 ml-1">ชื่อผู้ใช้งาน</label>
                        <input type="text" id="username" class="custom-input" placeholder="เลขบัตรประชาชน 13 หลัก" required>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-bold text-gray-700 ml-1">รหัสผ่าน</label>
                        <div class="relative">
                            <input type="password" id="password" class="custom-input pr-10" placeholder="รหัสผ่าน" required>
                            <button type="button" onclick="togglePassword('password', 'eye-icon')" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-blue-600 transition">
                                <i class="fas fa-eye" id="eye-icon"></i>
                            </button>
                        </div>
                    </div>
                    <div id="first-login-hint" class="bg-blue-50/80 border border-blue-100 rounded-xl p-3 text-center">
                        <p class="text-xs text-blue-600 font-medium"><i class="fas fa-key mr-1"></i> รหัสผ่านครั้งแรก: sateacher</p>
                    </div>
                    <button type="submit" class="w-full btn-primary py-3.5 text-lg shadow-lg shadow-blue-500/30">เข้าสู่ระบบ</button>
                </form>
            </div>
        </div>
    </div>

    <!-- ================= Dashboard Section ================= -->
    <div id="dashboard-section" class="hidden-section min-h-screen flex flex-col animate-fade-in relative z-0">
        <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none">
            <div class="absolute top-[-10%] right-[-10%] w-[40rem] h-[40rem] bg-pink-100 rounded-full mix-blend-multiply filter blur-3xl opacity-40"></div>
            <div class="absolute bottom-[-10%] left-[-10%] w-[40rem] h-[40rem] bg-blue-100 rounded-full mix-blend-multiply filter blur-3xl opacity-40"></div>
        </div>

        <!-- Responsive Navbar -->
        <nav class="glass-effect sticky top-0 z-50 shadow-sm border-b border-white/60">
            <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo & Title -->
                    <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
                        <img src="https://www.saard.ac.th/wp-content/uploads/2024/11/saardlogov2-1-1024x1024.png" alt="Logo" class="h-10 w-10 sm:h-12 sm:w-12 drop-shadow-sm flex-shrink-0">
                        <div class="flex flex-col">
                            <h1 class="text-sm sm:text-xl font-bold leading-tight flex flex-col sm:block">
                                <span class="text-gray-800">ระบบ</span><span class="text-pink-500">ขออนุญาตใช้ยานพาหนะ</span>
                            </h1>
                            <p class="text-[10px] sm:text-xs text-blue-600 font-medium bg-blue-50 inline-block px-2 py-0.5 rounded-full self-start" id="user-role-display">บุคลากรครู</p>
                        </div>
                    </div>
                    
                    <!-- Menu -->
                    <div class="flex items-center gap-1 sm:gap-3">
                        
                        <!-- Teacher Menu -->
                        <div id="nav-menu-teacher" class="bg-gray-100 p-1 rounded-xl relative flex items-center h-10 sm:h-12">
                            <div id="nav-t-indicator" class="absolute h-[calc(100%-0.5rem)] w-[calc(33.33%-0.25rem)] bg-white rounded-lg shadow-sm transition-all duration-300 ease-out top-1 left-1 pointer-events-none"></div>
                            
                            <button id="nav-t-home" onclick="showPage('home')" class="nav-toggle-btn relative z-10 flex-1 px-3 sm:px-5 py-1 sm:py-2 rounded-lg text-sm font-bold transition-colors text-blue-600 flex items-center justify-center gap-2">
                                <i class="fas fa-home"></i><span class="nav-toggle-text">หน้าหลัก</span>
                            </button>
                            <button id="nav-t-request" onclick="showPage('request')" class="nav-toggle-btn relative z-10 flex-1 px-3 sm:px-5 py-1 sm:py-2 rounded-lg text-sm font-bold transition-colors text-gray-500 flex items-center justify-center gap-2">
                                <i class="fas fa-edit"></i><span class="nav-toggle-text">ขออนุญาต</span>
                            </button>
                            <button id="nav-t-profile" onclick="showPage('profile')" class="nav-toggle-btn relative z-10 flex-1 px-3 sm:px-5 py-1 sm:py-2 rounded-lg text-sm font-bold transition-colors text-gray-500 flex items-center justify-center gap-2">
                                <i class="fas fa-user-circle"></i><span class="nav-toggle-text">ส่วนตัว</span>
                            </button>
                        </div>

                        <!-- Admin Menu -->
                        <div id="nav-menu-admin" class="hidden-section bg-gray-100 p-1 rounded-xl relative flex items-center h-10 sm:h-12">
                            <div id="nav-a-indicator" class="absolute h-[calc(100%-0.5rem)] w-[calc(50%-0.25rem)] bg-white rounded-lg shadow-sm transition-all duration-300 ease-out top-1 left-1 pointer-events-none"></div>
                            
                            <button id="nav-a-home" onclick="showPage('home')" class="nav-toggle-btn relative z-10 flex-1 px-3 sm:px-5 py-1 sm:py-2 rounded-lg text-sm font-bold transition-colors text-blue-600 flex items-center justify-center gap-2">
                                <i class="fas fa-home"></i><span class="nav-toggle-text">หน้าหลัก</span>
                            </button>
                            <button id="nav-a-manage" onclick="showPage('manage')" class="nav-toggle-btn relative z-10 flex-1 px-3 sm:px-5 py-1 sm:py-2 rounded-lg text-sm font-bold transition-colors text-gray-500 flex items-center justify-center gap-2">
                                <i class="fas fa-database"></i><span class="nav-toggle-text">จัดการข้อมูล</span>
                            </button>
                        </div>

                        <div class="h-6 sm:h-8 w-px bg-gray-300 mx-1 sm:mx-2"></div>
                        <button onclick="handleLogout()" class="text-gray-500 hover:text-red-500 font-medium text-sm p-2 rounded-lg hover:bg-red-50 transition-colors">
                            <i class="fas fa-sign-out-alt text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <div class="flex-grow p-4 sm:p-8 max-w-7xl mx-auto w-full space-y-6 sm:space-y-8 pb-20">
            
            <!-- View: Home (Dashboard) -->
            <div id="view-home" class="space-y-6 sm:space-y-8 animate-slide-up">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
                    <div id="card-dash-all" onclick="filterBookings('all')" class="glass-effect p-5 sm:p-6 rounded-3xl shadow-card hover:shadow-xl transition-all cursor-pointer border-l-8 border-blue-500 group relative overflow-hidden dash-active">
                        <div class="absolute right-0 top-0 w-24 sm:w-32 h-24 sm:h-32 bg-blue-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-xs sm:text-sm font-bold mb-1 tracking-wide uppercase">รายการทั้งหมด</p>
                                <h3 class="text-4xl sm:text-5xl font-bold text-gray-800 mt-2" id="count-all">0</h3>
                            </div>
                            <div class="p-3 sm:p-4 bg-blue-100 rounded-2xl text-blue-600 group-hover:bg-blue-600 group-hover:text-white transition shadow-sm"><i class="fas fa-list-ul text-xl sm:text-2xl"></i></div>
                        </div>
                    </div>
                    <div id="card-dash-pending" onclick="filterBookings('pending')" class="glass-effect p-5 sm:p-6 rounded-3xl shadow-card hover:shadow-xl transition-all cursor-pointer border-l-8 border-yellow-400 group relative overflow-hidden dash-inactive">
                        <div class="absolute right-0 top-0 w-24 sm:w-32 h-24 sm:h-32 bg-yellow-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-xs sm:text-sm font-bold mb-1 tracking-wide uppercase" id="label-pending">รออนุมัติ</p>
                                <h3 class="text-4xl sm:text-5xl font-bold text-gray-800 mt-2" id="count-pending">0</h3>
                            </div>
                            <div class="p-3 sm:p-4 bg-yellow-100 rounded-2xl text-yellow-600 group-hover:bg-yellow-500 group-hover:text-white transition shadow-sm"><i class="fas fa-clock text-xl sm:text-2xl"></i></div>
                        </div>
                    </div>
                    <div id="card-dash-processed" onclick="filterBookings('processed')" class="glass-effect p-5 sm:p-6 rounded-3xl shadow-card hover:shadow-xl transition-all cursor-pointer border-l-8 border-green-500 group relative overflow-hidden dash-inactive">
                        <div class="absolute right-0 top-0 w-24 sm:w-32 h-24 sm:h-32 bg-green-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-xs sm:text-sm font-bold mb-1 tracking-wide uppercase" id="label-processed">ตอบรับแล้ว</p>
                                <h3 class="text-4xl sm:text-5xl font-bold text-gray-800 mt-2" id="count-processed">0</h3>
                            </div>
                            <div class="p-3 sm:p-4 bg-green-100 rounded-2xl text-green-600 group-hover:bg-green-500 group-hover:text-white transition shadow-sm"><i class="fas fa-check-circle text-xl sm:text-2xl"></i></div>
                        </div>
                    </div>
                </div>

                <!-- List/Timeline Toggle Section -->
                <div class="glass-effect rounded-3xl shadow-card p-6 sm:p-8 border border-white/50">
                    <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                        <div class="flex items-center gap-4">
                             <h3 class="text-lg sm:text-xl font-bold text-gray-800 flex items-center gap-3">
                                <span class="w-2 h-6 sm:h-8 bg-gradient-to-b from-blue-500 to-pink-500 rounded-full"></span> 
                                <span id="table-title">รายการทั้งหมด</span>
                            </h3>
                            <!-- Toggle Button -->
                            <div class="flex bg-gray-200 rounded-lg p-1" id="view-toggle-container">
                                <button onclick="toggleView('list')" id="btn-view-list" class="px-3 py-1 rounded-md text-sm font-bold bg-white text-blue-600 shadow-sm transition">ตาราง</button>
                                <button onclick="toggleView('timeline')" id="btn-view-timeline" class="px-3 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-blue-600 transition">Timeline</button>
                            </div>
                        </div>
                       
                        <div class="flex gap-2">
                            <button id="btn-print-summary" onclick="printSummaryPDF()" class="hidden-section px-4 sm:px-5 py-2 sm:py-2.5 bg-purple-50 text-purple-600 rounded-xl hover:bg-purple-100 text-xs sm:text-sm font-bold transition shadow-sm border border-purple-100 hover:-translate-y-0.5"><i class="fas fa-print mr-2"></i>พิมพ์สรุป</button>
                        </div>
                    </div>
                    
                    <!-- 1. Table View -->
                    <div id="view-mode-list" class="block">
                        <div class="hidden md:block overflow-x-auto rounded-xl border border-gray-100">
                            <table class="w-full glass-table">
                                <thead>
                                    <tr>
                                        <th class="text-left w-32 rounded-tl-xl">วันที่ขอ</th>
                                        <th class="text-left">ผู้ขออนุญาต</th>
                                        <th class="text-left">รายการ</th>
                                        <th class="text-left w-24">ประเภท</th>
                                        <th class="text-left w-48">วันที่เดินทาง (ไป-กลับ)</th>
                                        <th class="text-center w-28">สถานะ</th>
                                        <th class="text-center w-24 rounded-tr-xl">จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>
                        <div id="mobile-card-container" class="md:hidden space-y-4"></div>
                        <div class="p-4 border-t border-gray-100 text-center text-gray-500 text-xs sm:text-sm">
                            แสดงข้อมูลล่าสุด 20 รายการ
                        </div>
                    </div>

                    <!-- 2. Timeline View -->
                    <div id="view-mode-timeline" class="hidden-section p-4 sm:p-6 bg-gray-50/50">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
                            <div class="flex flex-col sm:flex-row gap-4 w-full">
                                <div class="flex flex-col gap-1 w-full sm:w-auto">
                                    <label class="font-bold text-gray-700 text-sm">เลือกวันที่:</label>
                                    <input type="date" id="timeline-date" onchange="renderTimeline()" class="custom-input">
                                </div>
                                <div class="flex flex-col gap-1 w-full sm:w-auto">
                                    <label class="font-bold text-gray-700 text-sm">ประเภทรถ:</label>
                                    <select id="timeline-filter-type" onchange="renderTimeline()" class="custom-input">
                                        <option value="all">ทั้งหมด</option>
                                        <option value="รถตู้">รถตู้</option>
                                        <option value="รถกระบะ">รถกระบะ</option>
                                        <option value="รถบรรทุก">รถบรรทุก</option>
                                        <option value="รถยนต์ส่วนบุคคล">รถยนต์ส่วนบุคคล</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="timeline-container" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                            <!-- Timeline Cards Injected Here -->
                        </div>
                         <div class="flex gap-4 justify-center mt-4 text-xs text-gray-500">
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-gray-300 rounded-full"></div> ว่าง</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-yellow-400 rounded-full"></div> รออนุมัติ</div>
                            <div class="flex items-center gap-1"><div class="w-3 h-3 bg-red-500 rounded-full"></div> จองแล้ว</div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- View: Request Form (Teacher) -->
            <div id="view-request" class="hidden-section animate-slide-up">
                <div class="glass-effect max-w-4xl mx-auto rounded-[2rem] shadow-card p-6 sm:p-10 relative overflow-hidden border border-white/60">
                    <div class="absolute top-0 left-0 w-full h-3 bg-gradient-to-r from-blue-400 via-pink-400 to-blue-400"></div>
                    <div class="text-center mb-8">
                        <h2 class="text-2xl sm:text-3xl font-bold text-gray-800">แบบฟอร์มขออนุญาตใช้ยานพาหนะ</h2>
                        <p class="text-gray-500 mt-2 text-sm sm:text-base">กรอกข้อมูลให้ครบถ้วนเพื่อให้หัวหน้างานพิจารณา</p>
                    </div>
                    <form onsubmit="submitRequest(event)" class="space-y-6 sm:space-y-8">
                        <div class="bg-white/40 p-5 sm:p-8 rounded-3xl border border-white/60 shadow-sm">
                            <h3 class="font-bold text-blue-600 mb-4 sm:mb-6 flex items-center gap-3 text-base sm:text-lg border-b border-blue-100 pb-2">
                                <span class="bg-blue-100 p-2 rounded-lg"><i class="fas fa-user"></i></span> ข้อมูลผู้ขอ (อัตโนมัติ)
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">ชื่อ-นามสกุล</label>
                                    <input type="text" id="req-name-display" class="custom-input bg-gray-100 text-gray-500 cursor-not-allowed" readonly>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">เบอร์โทรศัพท์</label>
                                    <input type="tel" id="req-phone" class="custom-input" placeholder="0xxxxxxxxx" required>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white/40 p-5 sm:p-8 rounded-3xl border border-white/60 shadow-sm">
                            <h3 class="font-bold text-pink-600 mb-4 sm:mb-6 flex items-center gap-3 text-base sm:text-lg border-b border-pink-100 pb-2">
                                <span class="bg-pink-100 p-2 rounded-lg"><i class="fas fa-route"></i></span> รายละเอียดการเดินทาง
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">ประเภทรถที่ต้องการ</label>
                                    <select id="req-type" class="custom-input" required>
                                        <option value="" disabled selected>-- เลือกประเภทรถ --</option>
                                        <option value="รถตู้">รถตู้</option>
                                        <option value="รถกระบะ">รถกระบะ</option>
                                        <option value="รถบรรทุก">รถบรรทุก</option>
                                        <option value="รถยนต์ส่วนบุคคล">รถยนต์ส่วนบุคคล</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">วัน-เวลา เริ่มต้น</label>
                                    <input type="datetime-local" id="req-start" class="custom-input" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">วัน-เวลา สิ้นสุด</label>
                                    <input type="datetime-local" id="req-end" class="custom-input" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">สถานที่ที่ไป</label>
                                    <input type="text" id="req-location" class="custom-input" placeholder="ระบุจังหวัดหรือชื่อสถานที่" required>
                                </div>
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-bold text-gray-700 mb-2">เพื่อวัตถุประสงค์</label>
                                    <textarea id="req-purpose" rows="3" class="custom-input" placeholder="ระบุรายละเอียดการไปราชการหรือธุระ" required></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">จำนวนผู้โดยสาร (คน)</label>
                                    <input type="number" id="req-passengers" min="1" class="custom-input" placeholder="ไม่รวมคนขับ" required>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center gap-4 pt-4">
                            <button type="button" onclick="checkVehicleAvailability()" class="btn-secondary text-blue-600 bg-white border-blue-200 hover:bg-blue-50 py-3 px-6 shadow-sm">
                                <i class="fas fa-search mr-2"></i>ตรวจสอบรถว่าง
                            </button>
                            <button type="submit" class="btn-primary px-10 py-3 text-lg shadow-lg shadow-blue-500/30 transform hover:-translate-y-1">
                                <i class="fas fa-paper-plane mr-2"></i>ส่งคำขออนุญาต
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- View: Teacher Profile -->
             <div id="view-profile" class="hidden-section animate-slide-up">
                <div class="glass-effect max-w-lg mx-auto rounded-[2rem] shadow-card p-6 sm:p-10 text-center">
                    <div class="w-24 h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6 text-blue-600 text-4xl">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800" id="profile-name">-</h2>
                    <p class="text-gray-500 mb-6" id="profile-id">-</p>
                    
                    <div class="bg-gray-50 p-6 rounded-2xl border border-gray-100 text-left space-y-4">
                        <h3 class="font-bold text-gray-700 mb-2">จัดการรหัสผ่าน</h3>
                        
                        <!-- Current Password Display -->
                        <div>
                            <label class="block text-xs font-bold text-gray-500 mb-1">รหัสผ่านปัจจุบัน</label>
                            <div class="relative">
                                <input type="password" id="current-password-display" class="custom-input bg-gray-100 text-gray-600" readonly>
                                <button type="button" onclick="togglePassword('current-password-display', 'eye-curr')" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-blue-600 transition">
                                    <i class="fas fa-eye" id="eye-curr"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Change Password Form -->
                        <form onsubmit="changePassword(event)" class="space-y-4 pt-4 border-t border-gray-200">
                             <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">กำหนดรหัสผ่านใหม่</label>
                                <div class="relative">
                                    <input type="password" id="new-password" class="custom-input" placeholder="รหัสผ่านใหม่" required minlength="4">
                                    <button type="button" onclick="togglePassword('new-password', 'eye-new')" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-blue-600 transition">
                                        <i class="fas fa-eye" id="eye-new"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="submit" class="w-full btn-primary">บันทึกรหัสผ่านใหม่</button>
                        </form>
                    </div>
                </div>
             </div>


            <!-- View: Manage Data (Admin) -->
            <div id="view-manage" class="hidden-section animate-slide-up space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <!-- Vehicle Card -->
                    <div onclick="renderManageTable('vehicle')" id="card-manage-vehicle" class="glass-effect p-5 sm:p-6 rounded-3xl shadow-card cursor-pointer transition-all border-l-8 border-pink-500 group relative overflow-hidden manage-card-active">
                        <div class="absolute right-0 top-0 w-24 sm:w-32 h-24 sm:h-32 bg-pink-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-xs sm:text-sm font-bold mb-1 tracking-wide uppercase">จัดการข้อมูล</p>
                                <h3 class="text-xl sm:text-2xl font-bold text-pink-900 mt-2">ยานพาหนะ</h3>
                                <div class="text-4xl sm:text-5xl font-bold text-pink-900 mt-2" id="count-vehicles">0</div>
                            </div>
                            <div class="p-3 sm:p-4 bg-pink-100 text-pink-600 rounded-2xl group-hover:bg-pink-600 group-hover:text-white transition shadow-sm"><i class="fas fa-bus text-xl sm:text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Driver Card -->
                    <div onclick="renderManageTable('driver')" id="card-manage-driver" class="glass-effect p-5 sm:p-6 rounded-3xl shadow-card cursor-pointer transition-all border-l-8 border-pink-500 group relative overflow-hidden manage-card-inactive">
                        <div class="absolute right-0 top-0 w-24 sm:w-32 h-24 sm:h-32 bg-pink-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-xs sm:text-sm font-bold mb-1 tracking-wide uppercase">จัดการข้อมูล</p>
                                <h3 class="text-xl sm:text-2xl font-bold text-pink-900 mt-2">พนักงานขับรถ</h3>
                                <div class="text-4xl sm:text-5xl font-bold text-pink-900 mt-2" id="count-drivers">0</div>
                            </div>
                            <div class="p-3 sm:p-4 bg-pink-100 text-pink-600 rounded-2xl group-hover:bg-pink-600 group-hover:text-white transition shadow-sm"><i class="fas fa-user-tie text-xl sm:text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- Teacher Card -->
                    <div onclick="renderManageTable('teacher')" id="card-manage-teacher" class="glass-effect p-5 sm:p-6 rounded-3xl shadow-card cursor-pointer transition-all border-l-8 border-pink-500 group relative overflow-hidden manage-card-inactive">
                        <div class="absolute right-0 top-0 w-24 sm:w-32 h-24 sm:h-32 bg-pink-50 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <p class="text-gray-500 text-xs sm:text-sm font-bold mb-1 tracking-wide uppercase">จัดการข้อมูล</p>
                                <h3 class="text-xl sm:text-2xl font-bold text-pink-900 mt-2">บุคลากรครู</h3>
                                <div class="text-4xl sm:text-5xl font-bold text-pink-900 mt-2" id="count-teachers">0</div>
                            </div>
                            <div class="p-3 sm:p-4 bg-pink-100 text-pink-600 rounded-2xl group-hover:bg-pink-600 group-hover:text-white transition shadow-sm"><i class="fas fa-chalkboard-teacher text-xl sm:text-2xl"></i></div>
                        </div>
                    </div>

                </div>

                <div class="glass-effect rounded-3xl shadow-card p-6 sm:p-8 border border-white/50">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl sm:text-2xl font-bold text-gray-800 flex items-center gap-3">
                            <span class="w-2 h-6 sm:h-8 bg-gradient-to-b from-blue-500 to-pink-500 rounded-full"></span> 
                            <span id="manage-title">ข้อมูลยานพาหนะ</span>
                        </h3>
                        <button onclick="addNewData()" class="btn-primary px-4 sm:px-5 py-2 sm:py-2.5 text-sm shadow-md"><i class="fas fa-plus mr-2"></i>เพิ่มข้อมูล</button>
                    </div>
                    
                    <!-- Desktop Table -->
                    <div class="hidden md:block overflow-x-auto rounded-xl border border-gray-100">
                        <table class="w-full glass-table">
                            <thead id="manage-table-head"></thead>
                            <tbody id="manage-table-body"></tbody>
                        </table>
                    </div>

                    <!-- Mobile Card View -->
                    <div id="manage-mobile-container" class="md:hidden space-y-4">
                        <!-- Cards injected here -->
                    </div>

                </div>
            </div>

        </div>
    </div>

    <!-- ================= PDF Templates ================= -->
    <div id="pdf-container">
        <!-- Single Permission PDF -->
        <div id="pdf-template" class="pdf-page" style="width: 210mm; min-height: 297mm;">
            <div class="pdf-header" style="margin-top: 20px;">ใบขออนุญาตใช้รถส่วนกลาง</div>
            <div class="pdf-row">
                <span style="margin-left: auto;">ที่ <span class="dotted-line" style="width: 50px;"></span></span>
            </div>
            <div class="pdf-row" style="margin-bottom: 20px;">
                <span style="margin-left: auto;">วันที่ <span class="dotted-line" id="pdf-date" style="width: 150px;"></span></span>
            </div>
            
            <div class="pdf-content">
                <div style="margin-bottom: 5px;">เรียน ผู้อำนวยการโรงเรียนสอาดเผดิมวิทยา</div>
                <div style="margin-left: 60px; margin-bottom: 10px; text-indent: 0;">
                    ข้าพเจ้า <span id="pdf-name" class="dotted-line" style="width: 250px;"></span> 
                    ตำแหน่ง <span class="dotted-line" style="width: 150px;">บุคลากรครู</span>
                </div>
                <div style="margin-left: 60px; margin-bottom: 10px;">
                    ขออนุญาตใช้ 
                    <span class="checkbox-box" id="chk-van"></span> รถตู้ 
                    <span class="checkbox-box" id="chk-pickup"></span> รถกระบะ 
                    <span class="checkbox-box" id="chk-truck"></span> รถบรรทุก 
                    <span class="checkbox-box" id="chk-car"></span> รถยนต์ส่วนบุคคล
                </div>
                <div style="margin-left: 60px; margin-bottom: 10px;">
                    สถานที่ที่ไป <span id="pdf-location" class="dotted-line" style="width: 380px;"></span>
                </div>
                <div style="margin-left: 60px; margin-bottom: 10px;">
                    เพื่อ <span id="pdf-purpose" class="dotted-line" style="width: 440px;"></span>
                </div>
                <div style="margin-left: 60px; margin-bottom: 10px;">
                    มีผู้โดยสารจำนวน <span id="pdf-pax" class="dotted-line" style="width: 50px;"></span> คน 
                    ในวันที่ <span id="pdf-start" class="dotted-line" style="width: 200px;"></span>
                </div>
                <div style="margin-left: 60px; margin-bottom: 10px;">
                    ถึงวันที่ <span id="pdf-end" class="dotted-line" style="width: 200px;"></span>
                    และได้แนบหนังสืออนุญาตไปราชการมาด้วยแล้ว
                </div>
                <div style="text-align: right; margin-top: 30px; margin-right: 40px; line-height: 1.6;">
                    ลงชื่อ <span class="dotted-line" style="width: 180px;"></span> ผู้ขออนุญาต<br>
                    (<span id="pdf-sign-name"></span>)<br>
                    ตำแหน่ง บุคลากรครู<br>
                    เบอร์โทรศัพท์ <span id="pdf-phone"></span>
                </div>
                
                <hr style="border: 1px solid black; margin: 20px 0;">
                
                <div style="font-weight: bold; margin-bottom: 15px;">ผลการพิจารณา</div>
                <div style="margin-left: 20px; margin-bottom: 10px;">
                    <span class="checkbox-box" id="chk-approve"></span> เห็นควร อนุญาตและรับผิดชอบการใช้รถหมายเลขทะเบียน <span id="pdf-plate" class="dotted-line" style="width: 120px;"></span>
                </div>
                <div style="margin-left: 45px; margin-bottom: 10px;">
                    โดยมีนาย <span id="pdf-driver" class="dotted-line" style="width: 220px;"></span> เป็นพนักงานขับรถ
                </div>
                <div style="margin-left: 20px; margin-bottom: 10px;">
                    <span class="checkbox-box" id="chk-reject"></span> ไม่อนุญาตเพราะ <span id="pdf-reject-reason" class="dotted-line" style="width: 320px;"></span>
                </div>

                <div style="display: flex; justify-content: space-between; margin-top: 40px;">
                    <div style="text-align: center; width: 45%; line-height: 1.6;">
                        ลงชื่อ <span class="dotted-line" style="width: 150px;"></span><br>
                        (นางสาวจุฑาดา ชุมเกษียน)<br>
                        หัวหน้างานยานพาหนะ<br>
                        วันที่ <span class="dotted-line" style="width: 100px;"></span>
                    </div>
                    <div style="text-align: center; width: 45%; line-height: 1.6;">
                        ลงชื่อ <span class="dotted-line" style="width: 150px;"></span><br>
                        (นายหัตถเชษฐ์ แสงประดิษฐ์)<br>
                        รองผู้อำนวยการโรงเรียน ปฏิบัติราชการแทน<br>
                        ผู้อำนวยการโรงเรียนสอาดเผดิมวิทยา<br>
                        วันที่ <span class="dotted-line" style="width: 100px;"></span>
                    </div>
                </div>
                 <div style="margin-top: 40px; margin-left: 20px; line-height: 1.6;">
                    รับทราบ<br><br>
                    ลงชื่อ <span class="dotted-line" style="width: 150px;"></span> พนักงานขับรถ<br>
                    (<span id="pdf-driver-sign"></span>)
                </div>
            </div>
        </div>

        <!-- Summary PDF Template (Landscape) -->
        <div id="pdf-summary-template" class="pdf-page" style="width: 297mm; min-height: 210mm;">
            <h2 style="text-align: center; font-weight: bold; font-size: 24px; margin-bottom: 5px;">รายงานสรุปการใช้งานยานพาหนะ</h2>
            <p style="text-align: center; font-size: 16px; margin-bottom: 20px;">โรงเรียนสอาดเผดิมวิทยา</p>
            <div class="summary-table-container">
                <table class="summary-table">
                    <colgroup>
                        <col style="width: 5%;">
                        <col style="width: 10%;">
                        <col style="width: 12%;">
                        <col style="width: 18%;">
                        <col style="width: 20%;">
                        <col style="width: 15%;">
                        <col style="width: 13%;">
                        <col style="width: 7%;">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>ที่</th>
                            <th>ทะเบียนรถ</th>
                            <th>วันที่ขอ</th>
                            <th>ผู้ขอใช้</th>
                            <th>สถานที่</th>
                            <th>วันเดือนปี เวลา</th>
                            <th>พนักงานขับรถ</th>
                            <th style="white-space: nowrap;">หมายเหตุ</th> 
                        </tr>
                    </thead>
                    <tbody id="pdf-summary-body">
                        <!-- JS Injected -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCphlXsrhobH6cRH6IccRzX82GRUtglKsc",
            authDomain: "car-reserve-9719a.firebaseapp.com",
            databaseURL: "https://car-reserve-9719a-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "car-reserve-9719a",
            storageBucket: "car-reserve-9719a.firebasestorage.app",
            messagingSenderId: "1051488451166",
            appId: "1:1051488451166:web:e6facfa674615529d392cf",
            measurementId: "G-DEYDZKEKHV"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // Initial Data
        const vehiclesInit = [
            {name: "รถตู้ นข919", plate: "นข919", type: "รถตู้"},
            {name: "รถตู้ นข2112", plate: "นข2112", type: "รถตู้"},
            {name: "รถหกล้อ 40-0068", plate: "40-0068", type: "รถบรรทุก"},
            {name: "SUV กค7771", plate: "กค7771", type: "รถยนต์ส่วนบุคคล"},
            {name: "กระบะ บ6244", plate: "บ6244", type: "รถกระบะ"}
        ];
        const driversInit = [
            {name: "นายธวัชชัย จินตะวรณ์ (แขก)", phone: "0979292181"},
            {name: "นายอลงกรณ์ ศรีคัทธะนาม (โก้)", phone: "0968603459"},
            {name: "นายวันชัย มณีเรืองแสง (ชัย)", phone: "0968603459"},
            {name: "นายศรีเนตร ผลพฤกษา (เนตร)", phone: "0869403610"}
        ];

        // Global State
        let currentUser = null;
        let currentRole = 'teacher'; 
        let manageMode = 'vehicle';
        let dataBookings = [];
        let dataVehicles = [];
        let dataDrivers = [];
        let dataUsers = []; // Stores teacher accounts
        let currentFilter = 'all';

        // --- Initialization ---
        function init() {
            auth.signInAnonymously().catch(e => console.error(e));
            db.ref('vehicles').once('value', s => { if(!s.exists()) vehiclesInit.forEach(v => db.ref('vehicles').push(v)) });
            db.ref('drivers').once('value', s => { if(!s.exists()) driversInit.forEach(d => db.ref('drivers').push(d)) });

            db.ref('bookings').on('value', snap => {
                const val = snap.val();
                dataBookings = val ? Object.keys(val).map(k => ({id: k, ...val[k]})) : [];
                dataBookings.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)); 
                refreshDashboard();
            });
            db.ref('vehicles').on('value', snap => {
                const val = snap.val();
                dataVehicles = val ? Object.keys(val).map(k => ({id: k, ...val[k]})) : [];
                refreshDashboard();
            });
            db.ref('drivers').on('value', snap => {
                const val = snap.val();
                dataDrivers = val ? Object.keys(val).map(k => ({id: k, ...val[k]})) : [];
                refreshDashboard();
            });
            db.ref('users').on('value', snap => {
                const val = snap.val();
                dataUsers = val ? Object.keys(val).map(k => ({id: k, ...val[k]})) : [];
                refreshDashboard();
            });

            // Set default date for timeline
            document.getElementById('timeline-date').valueAsDate = new Date();
        }
        init();

        // --- Authentication ---
        function switchRole(role) {
            currentRole = role;
            const indicator = document.getElementById('role-indicator');
            const btnTeacher = document.getElementById('btn-login-teacher');
            const btnAdmin = document.getElementById('btn-login-admin');
            const hint = document.getElementById('first-login-hint');

            if (role === 'teacher') {
                indicator.style.transform = 'translateX(0)';
                btnTeacher.classList.replace('text-gray-400', 'text-blue-600');
                btnAdmin.classList.replace('text-blue-600', 'text-gray-400');
                document.getElementById('username').placeholder = "เลขบัตรประชาชน 13 หลัก";
                hint.classList.remove('hidden-section');
            } else {
                indicator.style.transform = 'translateX(100%)';
                btnTeacher.classList.replace('text-blue-600', 'text-gray-400');
                btnAdmin.classList.replace('text-gray-400', 'text-blue-600');
                document.getElementById('username').placeholder = "ชื่อผู้ใช้";
                hint.classList.add('hidden-section');
            }
        }

        function togglePassword(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text'; icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password'; icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();

            let success = false;
            let userObj = null;

            if (currentRole === 'admin' && u === 'admin' && p === 'saadmin') {
                success = true; 
                userObj = { role: 'admin', name: "หัวหน้างานยานพาหนะ", id: 'admin' };
            } else if (currentRole === 'teacher') {
                // Check against database
                const foundUser = dataUsers.find(user => user.cardId === u && user.password === p);
                if (foundUser) {
                    success = true;
                    userObj = { 
                        role: 'teacher', 
                        name: `${foundUser.prefix}${foundUser.name} ${foundUser.surname}`, 
                        id: foundUser.cardId, 
                        uid: foundUser.id,
                        prefix: foundUser.prefix,
                        realName: foundUser.name,
                        surname: foundUser.surname,
                        password: foundUser.password // Store password for display
                    };
                }
            }

            if (success) {
                currentUser = userObj;
                document.getElementById('login-section').classList.add('hidden-section');
                document.getElementById('dashboard-section').classList.remove('hidden-section');
                document.getElementById('user-role-display').innerText = currentUser.name;
                
                document.getElementById('nav-menu-teacher').classList.toggle('hidden-section', currentRole === 'admin');
                document.getElementById('nav-menu-admin').classList.toggle('hidden-section', currentRole !== 'admin');
                
                // Update profile display
                if(currentRole === 'teacher') {
                    document.getElementById('profile-name').innerText = currentUser.name;
                    document.getElementById('profile-id').innerText = `ID: ${currentUser.id}`;
                    document.getElementById('current-password-display').value = currentUser.password;
                    document.getElementById('req-name-display').value = currentUser.name; // Auto-fill
                    
                    // Update Dashboard Labels for Teacher
                    document.getElementById('label-pending').innerText = "รายการรออนุมัติของคุณ";
                    document.getElementById('label-processed').innerText = "รายการตอบรับแล้วของคุณ";
                } else {
                    // Update Dashboard Labels for Admin
                    document.getElementById('label-pending').innerText = "รออนุมัติ";
                    document.getElementById('label-processed').innerText = "ตอบรับแล้ว";
                }

                showPage('home');
                refreshDashboard();

                Swal.fire({
                    icon: 'success',
                    title: 'ยินดีต้อนรับ',
                    text: `เข้าสู่ระบบในฐานะ ${currentUser.name}`,
                    showConfirmButton: false,
                    timer: 1500
                });
            } else {
                Swal.fire({ icon: 'error', title: 'เข้าสู่ระบบไม่สำเร็จ', text: 'ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง หรือบัญชียังไม่ถูกสร้าง', confirmButtonText: 'ลองใหม่', confirmButtonColor: '#3B82F6' });
            }
        }

        function handleLogout() {
            Swal.fire({
                title: 'ออกจากระบบ?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#9CA3AF'
            }).then((result) => {
                if (result.isConfirmed) {
                    location.reload();
                }
            });
        }

        function changePassword(e) {
            e.preventDefault();
            const newPass = document.getElementById('new-password').value;
            if (currentUser && currentUser.uid) {
                db.ref(`users/${currentUser.uid}`).update({ password: newPass });
                Swal.fire('สำเร็จ', 'เปลี่ยนรหัสผ่านเรียบร้อยแล้ว', 'success');
                document.getElementById('new-password').value = '';
                document.getElementById('current-password-display').value = newPass; // Update display
            }
        }

        // --- Navigation ---
        function showPage(page) {
            ['view-home', 'view-request', 'view-manage', 'view-profile'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.classList.add('hidden-section');
            });
            document.getElementById('view-' + page).classList.remove('hidden-section');
            
            if (page === 'home') filterBookings('all');
            if (page === 'manage') renderManageTable('vehicle');
            
            updateNavState(page);
        }

        function updateNavState(activePage) {
            const activeColor = 'text-blue-600';
            const inactiveColor = 'text-gray-500';
            
            // Helper to reset all btns in a container
            const resetBtns = (prefix, items) => {
                items.forEach((item, index) => {
                     const btn = document.getElementById(`${prefix}-${item}`);
                     if(item === activePage) btn.classList.replace(inactiveColor, activeColor);
                     else btn.classList.replace(activeColor, inactiveColor);
                });
            };

            if (currentRole === 'teacher') {
                const indicator = document.getElementById('nav-t-indicator');
                const items = ['home', 'request', 'profile'];
                const idx = items.indexOf(activePage);
                if(idx !== -1) indicator.style.transform = `translateX(${idx * 100}%)`;
                resetBtns('nav-t', items);
            } else { // Admin
                const indicator = document.getElementById('nav-a-indicator');
                const items = ['home', 'manage'];
                const idx = items.indexOf(activePage);
                if(idx !== -1) indicator.style.transform = `translateX(${idx * 100}%)`;
                resetBtns('nav-a', items);
            }
        }

        function toggleView(mode) {
            const btnList = document.getElementById('btn-view-list');
            const btnTimeline = document.getElementById('btn-view-timeline');
            const viewList = document.getElementById('view-mode-list');
            const viewTimeline = document.getElementById('view-mode-timeline');

            if (mode === 'list') {
                btnList.className = "px-3 py-1 rounded-md text-sm font-bold bg-white text-blue-600 shadow-sm transition";
                btnTimeline.className = "px-3 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-blue-600 transition";
                viewList.classList.remove('hidden-section');
                viewTimeline.classList.add('hidden-section');
            } else {
                btnTimeline.className = "px-3 py-1 rounded-md text-sm font-bold bg-white text-blue-600 shadow-sm transition";
                btnList.className = "px-3 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-blue-600 transition";
                viewList.classList.add('hidden-section');
                viewTimeline.classList.remove('hidden-section');
                renderTimeline();
            }
        }

        function refreshDashboard() {
            if (!currentUser) return;
            
            let total = 0, pending = 0, processed = 0;
            dataBookings.forEach(b => {
                if (b.status !== 'rejected') total++;
                const isOwnerOrAdmin = currentUser.role === 'admin' || b.requesterId === currentUser.id;
                if (isOwnerOrAdmin) {
                    if (b.status === 'pending') pending++;
                    else if (b.status === 'approved' || b.status === 'rejected') processed++;
                }
            });

            document.getElementById('count-all').innerText = total;
            document.getElementById('count-pending').innerText = pending;
            document.getElementById('count-processed').innerText = processed;
            
            document.getElementById('count-vehicles').innerText = dataVehicles.length;
            document.getElementById('count-drivers').innerText = dataDrivers.length;
            document.getElementById('count-teachers').innerText = dataUsers.length;
            
            if (!document.getElementById('view-home').classList.contains('hidden-section')) {
                filterBookings(currentFilter);
                if(!document.getElementById('view-mode-timeline').classList.contains('hidden-section')) {
                    renderTimeline();
                }
            }
            if (!document.getElementById('view-manage').classList.contains('hidden-section')) {
                renderManageTable(manageMode);
            }
        }

        function filterBookings(status) {
            currentFilter = status;
            const tbody = document.getElementById('table-body');
            const mobileContainer = document.getElementById('mobile-card-container');
            const toggleContainer = document.getElementById('view-toggle-container');
            
            tbody.innerHTML = '';
            mobileContainer.innerHTML = '';
            
            const titles = { all: 'รายการทั้งหมด', pending: 'รออนุมัติ', processed: 'ตอบรับแล้ว' };
            document.getElementById('table-title').innerText = titles[status];

            // Manage Toggle Visibility
            if (status === 'all') {
                toggleContainer.classList.remove('invisible');
                toggleContainer.classList.remove('hidden-section');
            } else {
                toggleContainer.classList.add('hidden-section');
                // Force switch back to list view if hidden
                if (!document.getElementById('view-mode-timeline').classList.contains('hidden-section')) {
                    toggleView('list');
                }
            }

            // Update Active State for Dashboard Cards
            const statusMap = {
                'all': 'card-dash-all',
                'pending': 'card-dash-pending',
                'processed': 'card-dash-processed'
            };
            
            Object.keys(statusMap).forEach(key => {
                const el = document.getElementById(statusMap[key]);
                if(el) {
                    if(key === status) {
                        el.classList.add('dash-active');
                        el.classList.remove('dash-inactive');
                    } else {
                        el.classList.remove('dash-active');
                        el.classList.add('dash-inactive');
                    }
                }
            });

            const btnPrint = document.getElementById('btn-print-summary');
            if (currentUser.role === 'admin' && status === 'processed') btnPrint.classList.remove('hidden-section');
            else btnPrint.classList.add('hidden-section');

            let filtered = dataBookings.filter(b => {
                if (status === 'all') return true; 
                if (currentUser.role === 'teacher' && b.requesterId !== currentUser.id) return false;
                if (status === 'pending') return b.status === 'pending';
                if (status === 'processed') return b.status !== 'pending';
                return true; 
            });

            if (status === 'all') {
                filtered = filtered.filter(b => b.status !== 'rejected');
            }

            const displayData = filtered.slice(0, 20);

            if (displayData.length === 0) {
                const emptyMsg = `<tr><td colspan="7" class="text-center py-10 text-gray-400 bg-white/50">ไม่มีข้อมูลรายการ</td></tr>`;
                tbody.innerHTML = emptyMsg;
                mobileContainer.innerHTML = `<div class="text-center py-10 text-gray-400">ไม่มีข้อมูลรายการ</div>`;
                return;
            }

            displayData.forEach(b => {
                let statusBadge = '';
                let actionBtn = '';
                let mobileActionBtn = '';
                
                if (b.status === 'pending') {
                    statusBadge = `<span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-bold border border-yellow-200">รออนุมัติ</span>`;
                    if (currentUser.role === 'admin') {
                        actionBtn = `<button onclick="openApproval('${b.id}')" class="text-white bg-blue-500 hover:bg-blue-600 px-4 py-1.5 rounded-lg text-sm shadow-md transition">พิจารณา</button>`;
                        mobileActionBtn = actionBtn;
                    } else {
                        actionBtn = `<span class="text-gray-400 text-sm">-</span>`;
                    }
                } else if (b.status === 'approved') {
                    statusBadge = `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200">อนุมัติ</span>`;
                    actionBtn = `<button onclick="printSinglePDF('${b.id}')" class="text-red-500 bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-lg border border-red-200 transition text-sm font-bold"><i class="fas fa-file-pdf mr-1"></i> PDF</button>`;
                    mobileActionBtn = actionBtn;
                } else {
                    statusBadge = `<span class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold border border-red-200">ไม่อนุมัติ</span>`;
                    actionBtn = `<div class="flex gap-2 justify-center"><button onclick="printSinglePDF('${b.id}')" class="text-red-500 bg-red-50 hover:bg-red-100 px-3 py-1.5 rounded-lg border border-red-200 transition text-sm font-bold"><i class="fas fa-file-pdf"></i></button> <button onclick="Swal.fire({title:'เหตุผล', text:'${b.rejectReason}', confirmButtonText:'ปิด', confirmButtonColor:'#3B82F6'})" class="text-gray-500 hover:bg-gray-100 px-3 py-1.5 rounded-lg border transition text-sm">เหตุผล</button></div>`;
                    mobileActionBtn = actionBtn;
                }

                // Format DateTime string
                const startStr = `${formatDate(b.startDateTime)} ${new Date(b.startDateTime).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}`;
                const endStr = `${formatDate(b.endDateTime)} ${new Date(b.endDateTime).toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}`;
                const dateRangeStr = `<div class="flex flex-col"><span class="text-gray-800 font-medium">${startStr}</span><span class="text-gray-400 text-xs">ถึง ${endStr}</span></div>`;

                const tr = document.createElement('tr');
                tr.className = 'transition hover:bg-white/40';
                tr.innerHTML = `
                    <td class="text-left-align rounded-l-lg">${formatDate(b.created_at)}</td>
                    <td class="text-left-align font-bold text-gray-800">${b.requesterName}</td>
                    <td class="text-left-align"><div class="font-bold text-gray-700">${b.location}</div><div class="text-xs text-gray-500 truncate w-48">${b.purpose}</div></td>
                    <td class="text-left-align"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold border border-blue-100">${b.requestedType}</span></td>
                    <td class="text-left-align text-sm">${dateRangeStr}</td>
                    <td class="text-center">${statusBadge}</td>
                    <td class="text-center rounded-r-lg">${actionBtn}</td>
                `;
                tbody.appendChild(tr);

                const card = document.createElement('div');
                card.className = 'mobile-card';
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="text-xs text-gray-500">${formatDate(b.created_at)}</div>
                        <div>${statusBadge}</div>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">ผู้ขอ:</span>
                        <span class="mobile-card-value">${b.requesterName}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">สถานที่:</span>
                        <span class="mobile-card-value">${b.location}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">ประเภทรถ:</span>
                        <span class="mobile-card-value">${b.requestedType}</span>
                    </div>
                    <div class="mobile-card-row">
                        <span class="mobile-card-label">เดินทาง:</span>
                        <span class="mobile-card-value text-xs text-right">${startStr}<br>ถึง ${endStr}</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100 flex justify-end">
                        ${mobileActionBtn || ''}
                    </div>
                `;
                mobileContainer.appendChild(card);
            });
        }

        // --- Action Logic ---
        function checkVehicleAvailability() {
            const start = document.getElementById('req-start').value;
            const end = document.getElementById('req-end').value;
            const type = document.getElementById('req-type').value;

            if (!start || !end) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาระบุวันเวลาเริ่มต้นและสิ้นสุด', 'warning');
            
            const now = new Date();
            const sDate = new Date(start);
            const eDate = new Date(end);

            if (sDate < now.setHours(0,0,0,0)) return Swal.fire('วันที่ไม่ถูกต้อง', 'ไม่สามารถจองย้อนหลังได้', 'warning');
            if (eDate < sDate) return Swal.fire('เวลาไม่ถูกต้อง', 'เวลาสิ้นสุดต้องอยู่หลังเวลาเริ่มต้น', 'warning');

            const sTime = sDate.getTime();
            const eTime = eDate.getTime();
            const busyCars = new Set();
            
            dataBookings.forEach(b => {
                if (b.status === 'approved') { 
                    const bs = new Date(b.startDateTime).getTime();
                    const be = new Date(b.endDateTime).getTime();
                    if (sTime < be && eTime > bs) { 
                        busyCars.add(b.vehicleId); 
                    }
                }
            });

            // Filter free cars AND match requested type (if selected)
            let freeCars = dataVehicles.filter(v => !busyCars.has(v.id));
            if (type) freeCars = freeCars.filter(v => v.type === type);
            
            let html = `<div class="text-left bg-gray-50 p-4 rounded-xl border border-gray-200 max-h-60 overflow-y-auto">`;
            if (freeCars.length === 0) {
                html += `<p class="text-red-500 font-bold text-center">ไม่มีรถ${type ? 'ประเภท '+type : ''}ว่างในช่วงเวลานี้</p>`;
            } else {
                freeCars.forEach(c => html += `<div class="flex items-center gap-2 mb-2 text-green-700 border-b border-gray-100 pb-1 last:border-0"><i class="fas fa-check-circle"></i> <span class="font-bold">${c.name}</span> <span class="text-xs bg-white px-2 py-0.5 rounded border ml-auto">${c.type}</span></div>`);
            }
            html += `</div>`;

            Swal.fire({
                title: 'สถานะรถว่างเบื้องต้น',
                html: html,
                confirmButtonText: 'ตกลง',
                confirmButtonColor: '#3B82F6'
            });
        }

        function submitRequest(e) {
            e.preventDefault();
            const start = document.getElementById('req-start').value;
            const end = document.getElementById('req-end').value;
            const type = document.getElementById('req-type').value;

            if(!type) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกประเภทรถ', 'warning');

            const sDate = new Date(start);
            const eDate = new Date(end);
            const now = new Date();

            if (sDate < now.setHours(0,0,0,0)) return Swal.fire('ผิดพลาด', 'ไม่สามารถจองย้อนหลังได้', 'error');
            if (eDate < sDate) return Swal.fire('ผิดพลาด', 'วันสิ้นสุดต้องอยู่หลังเวลาเริ่มต้น', 'error');

            // --- Pre-check Availability Logic ---
            const sTime = sDate.getTime();
            const eTime = eDate.getTime();
            
            // 1. Get all vehicles of this type
            const totalVehiclesOfType = dataVehicles.filter(v => v.type === type);
            
            if (totalVehiclesOfType.length === 0) {
                 return Swal.fire('ไม่พบข้อมูล', `ไม่มีข้อมูลรถประเภท ${type} ในระบบ`, 'error');
            }

            // 2. Count Approved Bookings overlapping this time for this type
            const busyVehicleIds = new Set();
            dataBookings.forEach(b => {
                if (b.status === 'approved') {
                    const bs = new Date(b.startDateTime).getTime();
                    const be = new Date(b.endDateTime).getTime();
                    // Check overlap: (StartA < EndB) and (EndA > StartB)
                    if (sTime < be && eTime > bs) {
                        busyVehicleIds.add(b.vehicleId);
                    }
                }
            });

            // 3. Count how many of OUR type are busy
            let busyCountForType = 0;
            totalVehiclesOfType.forEach(v => {
                if (busyVehicleIds.has(v.id)) {
                    busyCountForType++;
                }
            });

            // 4. If all busy, block
            if (busyCountForType >= totalVehiclesOfType.length) {
                return Swal.fire({
                    icon: 'error',
                    title: 'รถเต็ม',
                    text: `รถประเภท ${type} ไม่ว่างในช่วงเวลาที่เลือก (${busyCountForType}/${totalVehiclesOfType.length} คัน)`,
                    confirmButtonText: 'ตกลง',
                    confirmButtonColor: '#EF4444'
                });
            }
            // ------------------------------------

            Swal.fire({
                title: 'ยืนยันการส่งคำขอ',
                text: 'ตรวจสอบข้อมูลถูกต้องครบถ้วนแล้ว',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ยืนยัน',
                cancelButtonText: 'แก้ไข',
                confirmButtonColor: '#3B82F6',
                cancelButtonColor: '#9CA3AF'
            }).then((result) => {
                if (result.isConfirmed) {
                    const data = {
                        requesterId: currentUser.id,
                        requesterName: currentUser.name,
                        requesterPhone: document.getElementById('req-phone').value,
                        startDateTime: start,
                        endDateTime: end,
                        location: document.getElementById('req-location').value,
                        purpose: document.getElementById('req-purpose').value,
                        passengers: document.getElementById('req-passengers').value,
                        requestedType: type,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    };
                    db.ref('bookings').push(data);
                    Swal.fire({ icon: 'success', title: 'ส่งคำขอเรียบร้อย', showConfirmButton: false, timer: 1500 });
                    e.target.reset();
                    document.getElementById('req-name-display').value = currentUser.name; // Restore name
                    showPage('home');
                }
            });
        }

        function openApproval(id) {
            const booking = dataBookings.find(b => b.id === id);
            const sTime = new Date(booking.startDateTime).getTime();
            const eTime = new Date(booking.endDateTime).getTime();
            const busyCars = new Set();
            const busyDrivers = new Set();
            
            dataBookings.forEach(b => {
                if (b.status === 'approved') {
                    const bs = new Date(b.startDateTime).getTime();
                    const be = new Date(b.endDateTime).getTime();
                    if (sTime < be && eTime > bs) {
                        busyCars.add(b.vehicleId);
                        busyDrivers.add(b.driverId);
                    }
                }
            });

            // Filter vehicles by type requested
            const freeCars = dataVehicles.filter(v => !busyCars.has(v.id) && v.type === booking.requestedType);
            const freeDrivers = dataDrivers.filter(d => !busyDrivers.has(d.id));

            const carOptions = freeCars.length ? freeCars.map(c => `<option value="${c.id}">${c.name} (${c.type})</option>`).join('') : '<option value="">ไม่มีรถประเภทนี้ว่าง</option>';
            const driverOptions = freeDrivers.length ? freeDrivers.map(d => `<option value="${d.id}">${d.name}</option>`).join('') : '<option value="">ไม่มีคนขับว่าง</option>';

            Swal.fire({
                title: 'พิจารณาคำขอ',
                width: '600px',
                html: `
                    <div class="text-left text-sm mb-4 bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-2">
                        <div class="grid grid-cols-2 gap-2">
                            <p><strong>ผู้ขอ:</strong> ${booking.requesterName}</p>
                            <p><strong>เบอร์โทร:</strong> ${booking.requesterPhone}</p>
                            <p><strong>วันที่เริ่ม:</strong> ${formatDate(booking.startDateTime)}</p>
                            <p><strong>สิ้นสุด:</strong> ${formatDate(booking.endDateTime)}</p>
                            <p><strong>จำนวนคน:</strong> ${booking.passengers} คน</p>
                            <p><strong>ประเภทรถ:</strong> ${booking.requestedType}</p>
                        </div>
                        <div class="border-t border-blue-200 pt-2">
                            <p><strong>ไปที่:</strong> ${booking.location}</p>
                            <p><strong>เพื่อ:</strong> ${booking.purpose}</p>
                        </div>
                    </div>
                    <div class="space-y-4 text-left">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">เลือกยานพาหนะ (${booking.requestedType})</label>
                            <select id="swal-car" class="w-full border-2 rounded-lg p-2 border-gray-200 focus:border-blue-500 outline-none">${carOptions}</select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">เลือกคนขับ</label>
                            <select id="swal-driver" class="w-full border-2 rounded-lg p-2 border-gray-200 focus:border-blue-500 outline-none">${driverOptions}</select>
                        </div>
                    </div>
                `,
                showCancelButton: true,
                showDenyButton: true,
                confirmButtonText: 'อนุมัติ',
                denyButtonText: 'ไม่อนุมัติ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#10B981',
                denyButtonColor: '#EF4444',
                cancelButtonColor: '#9CA3AF',
                preConfirm: () => {
                    return {
                        vehicleId: document.getElementById('swal-car').value,
                        driverId: document.getElementById('swal-driver').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const vId = result.value.vehicleId;
                    const dId = result.value.driverId;
                    if (!vId || !dId) return Swal.fire('ข้อมูลไม่ครบ', 'กรุณาเลือกรถและคนขับ', 'error');
                    
                    db.ref(`bookings/${id}`).update({
                        status: 'approved',
                        vehicleId: vId,
                        driverId: dId,
                        approver: currentUser.name,
                        approveDate: new Date().toISOString()
                    });
                    Swal.fire({ icon: 'success', title: 'อนุมัติเรียบร้อย', showConfirmButton: false, timer: 1500 });
                } else if (result.isDenied) {
                    Swal.fire({
                        title: 'ระบุเหตุผลการไม่อนุมัติ',
                        input: 'text',
                        inputPlaceholder: 'เช่น รถเต็ม, ภารกิจไม่เหมาะสม',
                        showCancelButton: true,
                        confirmButtonText: 'ยืนยัน',
                        cancelButtonText: 'ยกเลิก',
                        confirmButtonColor: '#EF4444'
                    }).then((res) => {
                        if (res.isConfirmed) {
                            db.ref(`bookings/${id}`).update({
                                status: 'rejected',
                                rejectReason: res.value || 'ไม่ระบุ',
                                approver: currentUser.name
                            });
                            Swal.fire({ icon: 'success', title: 'บันทึกเรียบร้อย', showConfirmButton: false, timer: 1500 });
                        }
                    });
                }
            });
        }

        // --- Management Logic ---
        function renderManageTable(type) {
            manageMode = type;
            const titles = { vehicle: 'ข้อมูลยานพาหนะ', driver: 'ข้อมูลพนักงานขับรถ', teacher: 'ข้อมูลบุคลากรครู' };
            document.getElementById('manage-title').innerText = titles[type];
            const thead = document.getElementById('manage-table-head');
            const tbody = document.getElementById('manage-table-body');
            const mobileContainer = document.getElementById('manage-mobile-container');
            
            // Update Card Active State
            ['vehicle', 'driver', 'teacher'].forEach(t => {
                const card = document.getElementById(`card-manage-${t}`);
                if (t === type) {
                    card.classList.add('manage-card-active');
                    card.classList.remove('manage-card-inactive');
                } else {
                    card.classList.remove('manage-card-active');
                    card.classList.add('manage-card-inactive');
                }
            });

            tbody.innerHTML = '';
            mobileContainer.innerHTML = '';
            
            const list = type === 'vehicle' ? dataVehicles : (type === 'driver' ? dataDrivers : dataUsers);
            
            if (type === 'vehicle') {
                thead.innerHTML = `<tr><th class="text-left rounded-tl-xl">ชื่อรถ</th><th class="text-center">ทะเบียน</th><th class="text-center">ประเภท</th><th class="text-center rounded-tr-xl">จัดการ</th></tr>`;
                list.forEach(item => {
                    // Desktop Row
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-left-align font-bold text-gray-800">${item.name}</td>
                        <td class="text-center"><span class="bg-gray-100 px-2 py-1 rounded text-sm">${item.plate}</span></td>
                        <td class="text-center">${item.type}</td>
                        <td class="text-center"><button onclick="deleteItem('${type}', '${item.id}')" class="text-red-500 hover:bg-red-50 w-8 h-8 rounded-full"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);

                    // Mobile Card
                    const card = document.createElement('div');
                    card.className = 'mobile-card';
                    card.innerHTML = `
                         <div class="flex justify-between items-start mb-2">
                             <h4 class="font-bold text-gray-800">${item.name}</h4>
                             <span class="bg-gray-100 px-2 py-0.5 rounded text-xs">${item.plate}</span>
                         </div>
                         <div class="text-sm text-gray-500 mb-2">${item.type}</div>
                         <div class="flex justify-end pt-2 border-t border-gray-100">
                             <button onclick="deleteItem('${type}', '${item.id}')" class="text-red-500 text-sm font-bold flex items-center gap-1"><i class="fas fa-trash"></i> ลบ</button>
                         </div>
                    `;
                    mobileContainer.appendChild(card);
                });
            } else if (type === 'driver') {
                thead.innerHTML = `<tr><th class="text-left rounded-tl-xl">ชื่อ-สกุล</th><th class="text-center">เบอร์โทร</th><th class="text-center rounded-tr-xl">จัดการ</th></tr>`;
                list.forEach(item => {
                    // Desktop Row
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-left-align font-bold text-gray-800">${item.name}</td>
                        <td class="text-center text-blue-600 font-medium">${item.phone}</td>
                        <td class="text-center"><button onclick="deleteItem('${type}', '${item.id}')" class="text-red-500 hover:bg-red-50 w-8 h-8 rounded-full"><i class="fas fa-trash"></i></button></td>
                    `;
                    tbody.appendChild(tr);

                    // Mobile Card
                    const card = document.createElement('div');
                    card.className = 'mobile-card';
                    card.innerHTML = `
                         <div class="flex justify-between items-start mb-2">
                             <h4 class="font-bold text-gray-800">${item.name}</h4>
                         </div>
                         <div class="text-sm text-blue-600 mb-2"><i class="fas fa-phone mr-1"></i> ${item.phone}</div>
                         <div class="flex justify-end pt-2 border-t border-gray-100">
                             <button onclick="deleteItem('${type}', '${item.id}')" class="text-red-500 text-sm font-bold flex items-center gap-1"><i class="fas fa-trash"></i> ลบ</button>
                         </div>
                    `;
                    mobileContainer.appendChild(card);
                });
            } else { // Teacher
                thead.innerHTML = `<tr><th class="text-left rounded-tl-xl">ชื่อ-สกุล</th><th class="text-center">เลขบัตรฯ</th><th class="text-center">รหัสผ่าน</th><th class="text-center rounded-tr-xl">จัดการ</th></tr>`;
                list.forEach(item => {
                    // Desktop Row
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="text-left-align font-bold text-gray-800">${item.prefix}${item.name} ${item.surname}</td>
                        <td class="text-center text-sm text-gray-500">${item.cardId}</td>
                        <td class="text-center text-sm font-mono text-blue-500">${item.password}</td>
                        <td class="text-center flex justify-center gap-2">
                            <button onclick="resetPassword('${item.id}')" class="text-yellow-500 hover:bg-yellow-50 w-8 h-8 rounded-full" title="รีเซ็ตรหัสผ่าน"><i class="fas fa-key"></i></button>
                            <button onclick="deleteItem('${type}', '${item.id}')" class="text-red-500 hover:bg-red-50 w-8 h-8 rounded-full"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);

                    // Mobile Card
                    const card = document.createElement('div');
                    card.className = 'mobile-card';
                    card.innerHTML = `
                         <div class="flex justify-between items-start mb-2">
                             <h4 class="font-bold text-gray-800">${item.prefix}${item.name} ${item.surname}</h4>
                         </div>
                         <div class="mobile-card-row"><span class="mobile-card-label">เลขบัตรฯ:</span> <span class="mobile-card-value">${item.cardId}</span></div>
                         <div class="mobile-card-row"><span class="mobile-card-label">รหัสผ่าน:</span> <span class="mobile-card-value font-mono text-blue-600">${item.password}</span></div>
                         <div class="flex justify-end gap-3 pt-2 border-t border-gray-100">
                             <button onclick="resetPassword('${item.id}')" class="text-yellow-500 text-sm font-bold flex items-center gap-1"><i class="fas fa-key"></i> รีเซ็ต</button>
                             <button onclick="deleteItem('${type}', '${item.id}')" class="text-red-500 text-sm font-bold flex items-center gap-1"><i class="fas fa-trash"></i> ลบ</button>
                         </div>
                    `;
                    mobileContainer.appendChild(card);
                });
            }
        }

        function addNewData() {
            if (manageMode === 'vehicle') {
                Swal.fire({
                    title: 'เพิ่มยานพาหนะ',
                    html: `
                        <div class="space-y-3 text-left">
                            <input id="new-v-name" class="swal2-input w-full mx-0" placeholder="ชื่อรถ">
                            <input id="new-v-plate" class="swal2-input w-full mx-0" placeholder="ทะเบียน">
                            <select id="new-v-type" class="swal2-input w-full mx-0">
                                <option>รถตู้</option><option>รถกระบะ</option><option>รถบรรทุก</option><option>รถยนต์ส่วนบุคคล</option>
                            </select>
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'บันทึก'
                }).then((res) => {
                    if (res.isConfirmed) {
                        db.ref('vehicles').push({
                            name: document.getElementById('new-v-name').value,
                            plate: document.getElementById('new-v-plate').value,
                            type: document.getElementById('new-v-type').value
                        });
                        Swal.fire('สำเร็จ', '', 'success');
                    }
                });
            } else if (manageMode === 'driver') {
                Swal.fire({
                    title: 'เพิ่มพนักงานขับรถ',
                    html: `
                        <div class="space-y-3 text-left">
                            <input id="new-d-name" class="swal2-input w-full mx-0" placeholder="ชื่อ-สกุล">
                            <input id="new-d-phone" class="swal2-input w-full mx-0" placeholder="เบอร์โทร">
                        </div>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'บันทึก'
                }).then((res) => {
                    if (res.isConfirmed) {
                        db.ref('drivers').push({
                            name: document.getElementById('new-d-name').value,
                            phone: document.getElementById('new-d-phone').value
                        });
                        Swal.fire('สำเร็จ', '', 'success');
                    }
                });
            } else { // Add Teacher
                 Swal.fire({
                    title: 'เพิ่มบุคลากรครู',
                    width: '700px',
                    html: `
                        <div class="space-y-4 text-left">
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h4 class="font-bold text-blue-600 mb-2">วิธีที่ 1: เพิ่มทีละคน</h4>
                                <div class="grid grid-cols-2 gap-2">
                                    <select id="new-t-prefix" class="border p-2 rounded"><option>นาย</option><option>นาง</option><option>นางสาว</option></select>
                                    <input id="new-t-name" class="border p-2 rounded" placeholder="ชื่อ">
                                    <input id="new-t-surname" class="border p-2 rounded" placeholder="นามสกุล">
                                    <input id="new-t-card" class="border p-2 rounded" placeholder="เลขบัตรฯ 13 หลัก">
                                </div>
                                <button onclick="addTeacherSingle()" class="mt-2 bg-blue-500 text-white px-4 py-1 rounded text-sm w-full">บันทึก 1 คน</button>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                                <h4 class="font-bold text-gray-600 mb-2">วิธีที่ 2: เพิ่มหลายคน (Copy Paste)</h4>
                                <p class="text-xs text-gray-400 mb-1">รูปแบบ: คำนำหน้า ชื่อ นามสกุล เลขบัตรฯ (เว้นวรรค / บรรทัดใหม่)</p>
                                <textarea id="new-t-bulk" class="w-full border p-2 rounded h-24 text-sm font-mono" placeholder="นาย สมชาย ใจดี 1234567890123\nนางสาว มีนา รักเรียน 1234567890124"></textarea>
                            </div>
                        </div>
                    `,
                    showCancelButton: true,
                    showConfirmButton: true,
                    confirmButtonText: 'บันทึก (หลายคน)',
                    confirmButtonColor: '#3B82F6',
                    preConfirm: () => {
                        const bulk = document.getElementById('new-t-bulk').value;
                        if(bulk) return bulk;
                        return null;
                    }
                }).then((res) => {
                    if (res.isConfirmed && res.value) {
                         // Process Bulk
                         const lines = res.value.split('\n');
                         let count = 0;
                         lines.forEach(line => {
                             const parts = line.trim().split(/\s+/); // Split by spaces
                             if(parts.length >= 4) {
                                 db.ref('users').push({
                                     prefix: parts[0],
                                     name: parts[1],
                                     surname: parts[2],
                                     cardId: parts[3],
                                     password: 'sateacher',
                                     role: 'teacher'
                                 });
                                 count++;
                             }
                         });
                         Swal.fire('สำเร็จ', `เพิ่มข้อมูล ${count} รายการ`, 'success');
                    }
                });
            }
        }

        window.addTeacherSingle = function() {
            const prefix = document.getElementById('new-t-prefix').value;
            const name = document.getElementById('new-t-name').value;
            const surname = document.getElementById('new-t-surname').value;
            const card = document.getElementById('new-t-card').value;

            if(!name || !surname || !card) return Swal.fire('ผิดพลาด', 'กรอกข้อมูลให้ครบ', 'error');
            
            db.ref('users').push({
                prefix, name, surname, cardId: card, password: 'sateacher', role: 'teacher'
            });
            Swal.fire('สำเร็จ', 'เพิ่มข้อมูลเรียบร้อย', 'success');
        }

        function resetPassword(uid) {
            Swal.fire({
                title: 'รีเซ็ตรหัสผ่าน?',
                text: "รหัสผ่านจะกลับเป็น 'sateacher'",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'รีเซ็ต',
                confirmButtonColor: '#F59E0B'
            }).then((res) => {
                if (res.isConfirmed) {
                    db.ref(`users/${uid}`).update({ password: 'sateacher' });
                    Swal.fire('สำเร็จ', 'รีเซ็ตรหัสผ่านแล้ว', 'success');
                }
            });
        }

        function deleteItem(type, id) {
            Swal.fire({
                title: 'ยืนยันการลบ?',
                text: "ข้อมูลจะหายไปอย่างถาวร",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ลบ',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#EF4444'
            }).then((res) => {
                if (res.isConfirmed) {
                    const collection = type === 'vehicle' ? 'vehicles' : (type === 'driver' ? 'drivers' : 'users');
                    db.ref(`${collection}/${id}`).remove();
                    Swal.fire({ icon: 'success', title: 'ลบข้อมูลสำเร็จ', showConfirmButton: false, timer: 1000 });
                }
            });
        }

        // --- Timeline Logic ---
        function renderTimeline() {
            const dateInput = document.getElementById('timeline-date').valueAsDate;
            const filterType = document.getElementById('timeline-filter-type').value;

            if(!dateInput) return;

            const container = document.getElementById('timeline-container');
            container.innerHTML = '';

            const selectedDateStart = new Date(dateInput);
            selectedDateStart.setHours(0,0,0,0);
            const selectedDateEnd = new Date(dateInput);
            selectedDateEnd.setHours(23,59,59,999);

            // Filter vehicles
            let displayVehicles = dataVehicles;
            if(filterType !== 'all') {
                displayVehicles = displayVehicles.filter(v => v.type === filterType);
            }

            if(displayVehicles.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400 py-8">ไม่มีรถประเภทนี้</div>`;
                return;
            }

            // Identify first vehicles of each type for displaying pending requests
            const firstVehicleIdsOfType = {};
            dataVehicles.forEach(v => {
                if(!firstVehicleIdsOfType[v.type]) firstVehicleIdsOfType[v.type] = v.id;
            });

            displayVehicles.forEach(v => {
                // Find bookings for this car on this day
                const dayBookings = dataBookings.filter(b => {
                    const bStart = new Date(b.startDateTime);
                    const bEnd = new Date(b.endDateTime);
                    const overlap = (bStart < selectedDateEnd && bEnd > selectedDateStart);
                    
                    if(!overlap) return false;

                    if (b.status === 'approved' && b.vehicleId === v.id) return true;
                    
                    // Show pending on the FIRST vehicle of that type
                    if (b.status === 'pending' && b.requestedType === v.type) {
                        return firstVehicleIdsOfType[v.type] === v.id;
                    }
                    
                    return false;
                });

                let barsHtml = '';
                dayBookings.forEach(b => {
                    const bStart = new Date(b.startDateTime);
                    const bEnd = new Date(b.endDateTime);

                    let startPct = 0;
                    let widthPct = 0;

                    const dayStart = selectedDateStart.getTime();
                    const dayEnd = selectedDateEnd.getTime();
                    const totalDay = 24 * 60 * 60 * 1000;

                    const actualStart = Math.max(bStart.getTime(), dayStart);
                    const actualEnd = Math.min(bEnd.getTime(), dayEnd);
                    
                    startPct = ((actualStart - dayStart) / totalDay) * 100;
                    widthPct = ((actualEnd - actualStart) / totalDay) * 100;

                    const colorClass = b.status === 'approved' ? 'segment-approved' : 'segment-pending';
                    
                    barsHtml += `<div class="timeline-segment ${colorClass}" style="left: ${startPct}%; width: ${widthPct}%;" title="${b.status}: ${b.requesterName}"></div>`;
                });

                const card = document.createElement('div');
                card.className = "bg-white p-3 rounded-xl border border-gray-200 shadow-sm";
                card.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-bold text-sm text-gray-700">${v.name}</span>
                        <span class="text-xs bg-gray-100 px-2 rounded">${v.plate}</span>
                    </div>
                    <div class="timeline-bar">
                        ${barsHtml}
                    </div>
                    <div class="time-scale">
                        <span>00:00</span><span>06:00</span><span>12:00</span><span>18:00</span><span>24:00</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- Helpers ---
        function formatDate(iso) {
            if (!iso) return "-";
            const d = new Date(iso);
            const months = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
            return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear() + 543}`;
        }

        function formatDateFull(iso) {
            if (!iso) return "-";
            const d = new Date(iso);
            const months = ['มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน', 'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'];
            return `${d.getDate()} ${months[d.getMonth()]} พ.ศ. ${d.getFullYear() + 543}`;
        }

        // --- PDF Generation ---
        function printSinglePDF(id) {
            const b = dataBookings.find(x => x.id === id);
            const v = dataVehicles.find(x => x.id === b.vehicleId) || {};
            const d = dataDrivers.find(x => x.id === b.driverId) || {};
            
            document.getElementById('pdf-date').innerText = formatDateFull(new Date());
            document.getElementById('pdf-name').innerText = b.requesterName;
            document.getElementById('pdf-location').innerText = b.location;
            document.getElementById('pdf-purpose').innerText = b.purpose;
            document.getElementById('pdf-pax').innerText = b.passengers;
            
            const s = new Date(b.startDateTime);
            const e = new Date(b.endDateTime);
            const timeStr = (date) => date.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'}) + " น.";
            
            document.getElementById('pdf-start').innerText = `${formatDateFull(b.startDateTime)} เวลา ${timeStr(s)}`;
            document.getElementById('pdf-end').innerText = `${formatDateFull(b.endDateTime)} เวลา ${timeStr(e)}`;
            document.getElementById('pdf-sign-name').innerText = b.requesterName;
            document.getElementById('pdf-phone').innerText = b.requesterPhone;
            document.getElementById('pdf-plate').innerText = v.plate || '-';
            document.getElementById('pdf-driver').innerText = d.name || '-';
            document.getElementById('pdf-driver-sign').innerText = d.name || '-';

            document.querySelectorAll('.checkbox-box').forEach(el => el.classList.remove('checkbox-checked'));
            // Check requested type for top section
            if (b.requestedType === 'รถตู้') document.getElementById('chk-van').classList.add('checkbox-checked');
            else if (b.requestedType === 'รถกระบะ') document.getElementById('chk-pickup').classList.add('checkbox-checked');
            else if (b.requestedType === 'รถบรรทุก') document.getElementById('chk-truck').classList.add('checkbox-checked');
            else if (b.requestedType === 'รถยนต์ส่วนบุคคล') document.getElementById('chk-car').classList.add('checkbox-checked');

            document.getElementById('chk-approve').classList.remove('checkbox-checked');
            document.getElementById('chk-reject').classList.remove('checkbox-checked');
            document.getElementById('pdf-reject-reason').innerText = "";

            if (b.status === 'approved') {
                document.getElementById('chk-approve').classList.add('checkbox-checked');
            } else if (b.status === 'rejected') {
                document.getElementById('chk-reject').classList.add('checkbox-checked');
                document.getElementById('pdf-reject-reason').innerText = b.rejectReason || "";
            }

            const element = document.getElementById('pdf-template');
            const opt = {
                margin: 0,
                filename: `ใบขออนุญาต_${b.requesterName}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 3, logging: false },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function printSummaryPDF() {
            const tbody = document.getElementById('pdf-summary-body');
            tbody.innerHTML = '';
            
            let count = 1;
            const approvedList = dataBookings.filter(b => b.status === 'approved').sort((a,b) => new Date(a.created_at) - new Date(b.created_at));

            approvedList.forEach(b => {
                const v = dataVehicles.find(x => x.id === b.vehicleId) || {};
                const d = dataDrivers.find(x => x.id === b.driverId) || {};
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${count++}</td>
                    <td>${v.plate || '-'}</td>
                    <td>${formatDate(b.created_at)}</td>
                    <td class="text-left-align">${b.requesterName}</td>
                    <td class="text-left-align">${b.location}</td>
                    <td>${formatDate(b.startDateTime)}<br>- ${formatDate(b.endDateTime)}</td>
                    <td>${d.name || '-'}</td>
                    <td></td>
                `;
                tbody.appendChild(tr);
            });

            const element = document.getElementById('pdf-summary-template');
            const opt = {
                margin: [10, 0, 10, 0],
                filename: `รายงานสรุปการใช้รถ.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 4, logging: false, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
            };
            html2pdf().set(opt).from(element).save();
        }

    </script>
</body>
</html>
